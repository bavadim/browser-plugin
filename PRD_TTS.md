# PRD: Скилл «Озвучка статьи» (OpenAI TTS)

## Цель
Добавить скилл “Озвучка статьи” с плеером “как в Telegram”: кнопка Play/Pause, прогресс‑бар, текущее время/длительность (приблизительная). По нажатию проигрывается озвучка статьи после LLM‑предобработки.

## Scope
- Формат фичи: скилл.
- Источник статьи: HTML страницы (сырые данные извлечения, например `articleExtractHtml`).
- Предобработка: LLM переписывает HTML в чистый связный текст.
  - Удалить/нейтрализовать ссылки (URL, якоря).
  - Убрать артефакты извлечения (повторы, мусорные блоки, меню, подписи кнопок).
  - Сохранить смысл и структуру (заголовки, абзацы, списки).
- TTS: OpenAI `v1/audio/speech` по результату предобработки.
- Воспроизведение — внутри страницы (HTMLAudioElement).
- Пауза/продолжение/стоп.

## Важные факты про OpenAI TTS
- API: `POST /v1/audio/speech`. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
- Модели: `gpt-4o-mini-tts`, `tts-1`, `tts-1-hd`. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
- Есть набор голосов (например `alloy`, `nova`, `shimmer`, `marin`, `cedar` и т.д.). ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
- Поддерживаются форматы: `mp3`, `opus`, `wav`, `aac`, `flac`, `pcm`. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
- Требование по политике: пользователю нужно явно сообщить, что голос AI‑генерированный. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))

## UX
- В панели рядом со слайдером (или ниже) для скилла:
  - Play/Pause (toggle)
  - Stop
  - прогресс (0:00 / 12:34)
  - тонкий таймлайн как в Telegram
- Лейбл: “AI‑озвучка” (дисклеймер).

## Поведение
1. Пользователь нажимает Play в скилле “Озвучка статьи”.
2. Если текст ещё не подготовлен — запустить LLM‑предобработку HTML → чистый текст.
3. Если аудио ещё не создано — отправить запрос в TTS API и начать загрузку.
4. После получения аудио — проигрывание через `<audio>`:
   - `play()` / `pause()` / `currentTime = 0`
5. Таймлайн обновляется по `timeupdate`.

## Архитектура

### Предобработка (LLM)
- Вход: HTML статьи (сырое извлечение).
- Выход: связный текст для озвучки.
- Требования:
  - Удалить URL, якоря, “читать далее”, хлебные крошки, кнопки, навигацию.
  - Убрать артефакты вроде повторяющихся заголовков, рекламных вставок, обрывов слов.
  - Сохранить логические разделы и порядок.
- Рекомендуется добавить ограничение на длину и “мягкое” сокращение, если статья слишком длинная.
- Дедупликация:
  - Схлопывать повторяющиеся заголовки и повторы абзацев.
  - Удалять блоки “Related/Читайте также” и повторяющиеся списки ссылок.

### Вариант A (проще, но длинные статьи тяжелее)
- Одним запросом отправлять весь текст (ограничение по токенам).
- Получать целиком mp3.
- Минус: большие статьи могут превышать лимиты, долго ждать.

### Вариант B (рекомендуемый)
- Разбивать Markdown на чанки (например 1200–1500 токенов).
- Запрашивать по чанку.
- Склеивать в один Blob (либо плейлист).
- Итог: стабильнее, можно показывать прогресс загрузки.

## Ограничения
- 2000 input tokens у `gpt-4o-mini-tts` на один запрос (важно для chunking). ([platform.openai.com](https://platform.openai.com/docs/models/gpt-4o-mini-tts?utm_source=openai))
- Возможны разные наборы голосов по моделям. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
- Лимиты RPM/TPM зависят от тарифа. ([platform.openai.com](https://platform.openai.com/docs/models/gpt-4o-mini-tts?utm_source=openai))

## Предложение по реализации

### LLM‑предобработка (пример)
1. Извлечь HTML статьи.
2. Отправить в LLM с инструкцией: “Перепиши HTML в чистый связный текст для озвучки, удаляя ссылки и мусор. Сохрани структуру.”
3. Получить `cleanArticleText` и использовать его для TTS/chunking.

### LLM‑предобработка (детальный промпт)
Системные требования:
- Ты редактор, готовишь текст для озвучки.
- Нельзя выводить HTML, только чистый текст.
- Нельзя оставлять ссылки, URL, якоря, email, соц‑хендлы.
- Нельзя добавлять факты или придумывать текст.

Инструкция:
```
Задача: переписать HTML статьи в чистый связный текст для озвучки.
Требования:
1) Удали навигацию, меню, “читать далее”, кнопки, хлебные крошки, рекламные блоки, “Related/Читайте также”.
2) Удали все URL и якоря, вместо них оставь обычный текст без ссылок.
3) Убери мусорные элементы (повторы, обрывки фраз, списки ссылок, подписи кнопок).
4) Сохрани структуру: заголовки и абзацы, списки, но без HTML.
5) Сохрани порядок и смысл, не добавляй ничего от себя.
Формат: чистый текст. Каждый абзац с новой строки.
```

### Критерии качества текста (Definition of Done)
- Нет HTML, URL, якорей, email, соц‑хендлов.
- Нет навигации, рекламных блоков, повторяющихся заголовков и блоков “Читайте также”.
- Текст связан, читается вслух без “обрывов” и случайных списков.
- Сохранены ключевые заголовки и порядок разделов.
- Нет добавленных фактов, только переработка исходника.

### Лимиты длины и “мягкое” сокращение
- Цель: ограничить длину текста для TTS при длинных статьях.
- Правило:
  - Сначала удалять все блоки “Related/Читайте также” и повторяющиеся абзацы.
  - Если все еще слишком длинно, сокращать второстепенные примеры и длинные списки, сохраняя основные тезисы.
  - Нельзя обрезать середину абзаца; сокращение только по границам абзацев/пунктов.

### API вызов
```
POST /v1/audio/speech
{
  "model": "gpt-4o-mini-tts",
  "voice": "marin",
  "input": "<chunk text>",
  "response_format": "mp3"
}
```
([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))

### UI‑состояния
- Idle → Loading → Playing → Paused → Stopped
- В Loading показывать спиннер/прогресс загрузки.

### Дисклеймер
Внизу панели: “AI‑озвучка (сгенерировано)”. ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))

## Интеграция с текущим пайплайном
- Использовать `articleExtractHtml` как основной вход в LLM‑предобработку.
- Если HTML недоступен, fallback на `articleExtractMd` с дополнительной очисткой ссылок/артефактов.
- Результат предобработки сохранять как `cleanArticleText` и использовать для:
  - chunking и запросов TTS;
  - отображения длительности (приблизительно).
- Кэшировать `cleanArticleText` и аудио по URL статьи, чтобы повторно не гонять LLM/TTS при повторном нажатии Play.

## Вопросы для решения
1. Модель: `gpt-4o-mini-tts` (по умолчанию) или `tts-1/tts-1-hd`?
2. Голос: какой предпочитаем? (`marin`/`cedar` — рекомендованные для качества). ([platform.openai.com](https://platform.openai.com/docs/guides/text-to-speech?utm_source=openai))
3. Chunking: делаем сразу? (рекомендуется).
4. Лимиты длины и правила “мягкого” сокращения текста перед TTS.
